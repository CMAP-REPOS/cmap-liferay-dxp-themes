THREE.CopyShader={uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.EffectComposer=function(e,t){if(this.renderer=e,void 0===t){var r=window.innerWidth||1,o=window.innerHeight||1,i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1};t=new THREE.WebGLRenderTarget(r,o,i)}this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===THREE.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),this.copyPass=new THREE.ShaderPass(THREE.CopyShader)},THREE.EffectComposer.prototype={swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2;var t,r,o=!1,i=this.passes.length;for(r=0;i>r;r++)if(t=this.passes[r],t.enabled&&(t.render(this.renderer,this.writeBuffer,this.readBuffer,e,o),t.needsSwap)){if(o){var n=this.renderer.context;n.stencilFunc(n.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),n.stencilFunc(n.EQUAL,1,4294967295)}this.swapBuffers()}},reset:function(e){void 0===e&&(e=this.renderTarget1.clone(),e.width=window.innerWidth,e.height=window.innerHeight),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){var r=this.renderTarget1.clone();r.width=e,r.height=t,this.reset(r)}},THREE.RenderPass=function(e,t,r,o,i){this.scene=e,this.camera=t,this.overrideMaterial=r,this.clearColor=o,this.clearAlpha=void 0!==i?i:1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.enabled=!0,this.clear=!0,this.needsSwap=!1},THREE.RenderPass.prototype={render:function(e,t,r){this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),e.render(this.scene,this.camera,r,this.clear),this.clearColor&&e.setClearColor(this.oldClearColor,this.oldClearAlpha),this.scene.overrideMaterial=null}},THREE.ShaderPass=function(e,t){this.textureID=void 0!==t?t:"tDiffuse",this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader}),this.renderToScreen=!1,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.scene.add(this.quad)},THREE.ShaderPass.prototype={render:function(e,t,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=r),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}},THREE.FXAAShader={uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","float opacity  = rgbaM.w;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec3 rgbA = texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 1.0 / 3.0 - 0.5 ) ).xyz;","rgbA += texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 2.0 / 3.0 - 0.5 ) ).xyz;","rgbA *= 0.5;","vec3 rgbB = texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * -0.5 ).xyz;","rgbB += texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * 0.5 ).xyz;","rgbB *= 0.25;","rgbB += rgbA * 0.5;","float lumaB = dot( rgbB, luma );","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = vec4( rgbA, opacity );","} else {","gl_FragColor = vec4( rgbB, opacity );","}","}"].join("\n")},THREE.HorizontalTiltShiftShader={uniforms:{tDiffuse:{type:"t",value:null},h:{type:"f",value:1/512},r:{type:"f",value:.35},spread:{type:"f",value:1.2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float h;","uniform float r;","uniform float spread;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","float hh = h * pow( abs( r - vUv.y) , spread);","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * hh, vUv.y ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * hh, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * hh, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * hh, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * hh, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * hh, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * hh, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * hh, vUv.y ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},THREE.VerticalTiltShiftShader={uniforms:{tDiffuse:{type:"t",value:null},v:{type:"f",value:1/512},r:{type:"f",value:.35},spread:{type:"f",value:1.2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float v;","uniform float r;","uniform float spread;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","float vv = v * pow( abs( r - vUv.y ) ,spread);","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * vv ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * vv ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * vv ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * vv ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * vv ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * vv ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * vv ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * vv ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},window.CMAP={classes:{},tools:{},build:{}},CMAP.classes.World=function(e,t,r,o){var i=!0,n=this,a=/^((?!chrome).)*safari/i.test(navigator.userAgent);this.quality=a?"lq":"hq",this.projection=t,CMAP.tools.createThree.call(this,e,o),this.mouse=new CMAP.classes.Mouse3d(this),this.camera.setProjection(this.projection),this.FX=new CMAP.classes.FX(this.renderer,this.scene,this.camera,this),r=r||[];for(var s=0;s<r.length;s++)this.FX.add(r[s]);this.FX.add("FXAA").add("copyShader").resize(),e.style.visibility="hidden",this.render=new CMAP.classes.renderManager,this.render.add(this.camera.render,this.camera.pause),this.render.add(this.FX.render),this.start=function(){var t=i;e.style.visibility="visible",i=!1,t&&n.render.start()},this.stop=function(){i=!0,n.render.stop()};var l=function(){var e=this.renderer.domElement.parentNode.offsetWidth,t=this.renderer.domElement.parentNode.offsetHeight;o&&(t=o),1024>e&&(e=1024),this.renderer.setSize(e,t),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.FX.resize()}.bind(this),c=function(){CMAP.tools.destroyGroup(this.group,this.scene),this.renderer.clear(),this.FX.destroy(),this.mouse.destroy(),this.FX=void 0,this.camera=void 0,this.scene=void 0,this.group=void 0,this.mouse=void 0,this.render=void 0;var e=this.renderer.domElement;e.parentNode.removeChild(e),n=void 0}.bind(this);window.addEventListener("resize",l,!1),e.addEventListener("webglcontextlost",function(){console.error("webgl stopped due to context lost"),n.stop()},!1),this.destroy=function(){n.render.stop(!0),window.removeEventListener("resize",l,!1),c()}},CMAP.classes.Projection=function(e,t){t=t||20;var r=d3.geo.mercator().scale(Math.pow(2,t)).center(e);this.translate=function(e,t){return r([e,t])},this.translate3D=function(e,t){var o=r([e,t]);return new THREE.Vector2(o[0],o[1])},this.reverse=function(e){return r.invert([e.x,e.y])},this.d3=r},CMAP.classes.GeoCamera=function(e,t,r,o,i){var n,a,s,l={},c={},d="fixed",u=new THREE.PerspectiveCamera(e,t,r,o);u.needsUpdate=!1;var h=function(e){var t=i.localToWorld(e);return t.y*=-1,t};u.setProjection=function(e){return n=e,u},u.gotoGeo=function(e,t,r){var o=n.translate3D(e,t),i=h(new THREE.Vector3(o.x,o.y,r));return u.position.copy(i),a=i.clone(),u},u.lookAtGeo=function(e,t,r){var o=n.translate3D(e,t),i=h(new THREE.Vector3(o.x,o.y,r));return u.lookAt(i),s=i.clone(),u},u.interpolateTo=function(e,t,r,o){var i;i=n.translate3D(e.lat,e.lon),i=new THREE.Vector3(i.x,i.y,e.height);var a;a=n.translate3D(t.lat,t.lon),a=new THREE.Vector3(a.x,a.y,e.height);var s=new THREE.Line3(i,a),l=s.distance(),c=r/l;c>.8&&(c=.8);var d;o?(c+=1,d=s.at(c)):d=s.at(1-c),u.animateTo(h(d),t)},u.animateTo=function(e,t,r,o){var i,c;return r=r||2e3,e instanceof THREE.Vector3==!1?(i=n.translate3D(e.lat,e.lon),i=h(new THREE.Vector3(i.x,i.y,e.height))):i=e,t instanceof THREE.Vector3==!1?(c=n.translate3D(t.lat,t.lon),c=h(new THREE.Vector3(c.x,c.y,t.height))):c=t.clone(),l={type:"fly",from:a.clone(),lookFrom:s.clone(),to:i,lookTo:c,timeFrom:+Date.now(),timeTo:+Date.now()+r},o&&(l.callback=o),u.needsUpdate=!0,u};var f=function(e,t,r,o,i){return new THREE.Vector3(e.x+t*Math.cos(o*i),r,e.z+t*Math.sin(o*i))};u.flyAround=function(e,t,r,o,i){t=t||500,r=r||250,o=o||.1;var a,c;if(e instanceof THREE.Vector3)a=h(e.clone()),c=a.clone();else{e.height=e.height||-50;var d=n.translate3D(e.lat,e.lon);a=h(new THREE.Vector3(d.x,d.y,e.height)),c=a.clone()}var v=f(a,t,r,o,0);i?(l={type:"hover",start:+Date.now(),count:0,speed:o,radius:t,center:a,height:r},s=l.center.clone()):u.animateTo(v,c,1e3,function(){u.flyAround(e,t,r,o,!0)}),u.needsUpdate=!0};var v=!1;return u.pause=function(){v=!0},u.render=function(){if(!u.needsUpdate)return!1;if(d="moving","hover"===l.type){l.count+=.02;var e=f(l.center,l.radius,l.height,l.speed,l.count);u.position.copy(e),u.lookAt(l.center),a=u.position.clone()}else if("fly"===l.type){var t=l.timeTo-l.timeFrom,r=+Date.now()-l.timeFrom,o=r/t;if(v&&o>1&&(o=1),v=!1,1>=o){o>1&&(o=1);var i=CMAP.tools.lerp3(l.from,l.to,o),n=CMAP.tools.lerp3(l.lookFrom,l.lookTo,o);u.position.x=i.x,u.position.y=i.y,u.position.z=i.z,u.lookAt(n),a=i.clone(),s=n.clone()}else{u.needsUpdate=!1,c=l,d="fixed";var h=l.callback||void 0;l={},void 0!==h&&h()}}},u},CMAP.classes.FX=function(e,t,r,o){this.dpr=window.devicePixelRatio||1,"hq"===o.quality?this.dpr=2:"lq"===o.quality&&(this.dpr=1),this.composer=new THREE.EffectComposer(e),this.composer.setSize(e.domElement.parentNode.offsetWidth*this.dpr,e.domElement.parentNode.offsetHeight*this.dpr),this.renderPass=new THREE.RenderPass(t,r,null,new THREE.Color(16777215)),this.composer.addPass(this.renderPass);var i=e.context,n=i.getParameter(i.MAX_TEXTURE_SIZE);this.add=function(i){return CMAP.FXlib[i].call(this,t,r,e,o),this},this.render=function(e){this.composer.render(e)}.bind(this),this.setBackground=function(e){return this.renderPass.clearColor=e,this},this.resize=function(){var t,r=e.domElement.parentNode.offsetWidth*this.dpr,o=e.domElement.parentNode.offsetHeight*this.dpr;1024>r&&(r=1024),r>o&&r>n?(t=o/r,r=n,o*=t):o>r&&o>n&&(t=r/o,o=n,n*=t),this.composer.setSize(r,o),this.effectFXAA&&this.effectFXAA.uniforms.resolution.value.set(1/r,1/o)},this.destroy=function(){this.composer.reset(),this.composer.renderTarget1.dispose(),this.composer.renderTarget2.dispose(),this.composer.renderTarget1=void 0,this.composer.renderTarget2=void 0},e.context.canvas.drawingBufferWidth>window.width&&console.log("ISSUE")},CMAP.classes.Layer3D=function(e){var t,r,o,i={},n=[];this.data=function(e,i){if(i=CMAP.tools.parseHeight(i),e instanceof Array){t=[];for(var n=0;n<e.length;n++)t=t.concat(e[n].map3D(i));o=e[0].getBoundingBox()}else t=e.map3D(i),o=e.getBoundingBox();return r=i,this},this.options=function(e){return i=e,this},this.build=function(a,s){var l=s||r,c={data:t,boundingbox:o,options:i,z:l},d=a.call(c,e);return n=CMAP.tools.actionExtend(n,d),this},this.action=function(t,r){var o;if(n[t]instanceof Array){o=[];for(var i=0;i<n[t].length;i++)o.push(n[t][i].call(e,r))}else o=n[t].call(e,r);return o},this.destroy=function(){t=void 0,i=void 0,r=void 0,o=void 0,n=void 0}},CMAP.classes.Mouse3d=function(e){var t=[],r=e.renderer.domElement,o=function(o){var i=r.getBoundingClientRect().top+document.body.scrollTop,n=o.clientY-i+document.body.scrollTop,a=new THREE.Vector3(o.clientX/window.innerWidth*2-1,2*-(n/window.innerHeight)+1,.5);a.unproject(e.camera);var s=new THREE.Raycaster(e.camera.position,a.sub(e.camera.position).normalize()),l=s.intersectObjects(t);if(l.length>0){var c=l[0],d=c.object,u=c.point;c.geo=e.projection.reverse(u),d.onClick&&d.onClick(c)}};r.addEventListener("click",o),this.addSpot=function(e,r){r&&(e.onClick=r),t.push(e)},this.destroy=function(){t=void 0,window.removeEventListener("resize",o,!1)}},CMAP.classes.Label3D=function(){var e,t,r,o,i='"Freight Micro", Georgia, "Times New Roman", serif',n="100",a=24;this.background=function(e){return o=e||{},o.color=o.background||new THREE.Color("#FFFFFF"),o.background=o.background||new THREE.Color("#2B3741"),o.padding=o.padding||24,o.size=o.size||24,o.letterSpacing=o.letterSpacing||1,this},this.text=function(o,n,s){return e=o.toUpperCase(),t=n||i,r=s||a,this},this.create=function(){o||this.background(),e||console.warn("no text given for 3D label");var i=document.createElement("canvas"),a=i.getContext("2d");a.font=r+"px "+t;var s=a.measureText(e),l=s.width,c=2.25*r,d=s.width+e.length*o.letterSpacing+2*o.padding;a.canvas.width=d,a.canvas.height=c,a.font=n+" "+r+"px "+t;var u=255*o.background.r,h=255*o.background.g,f=255*o.background.b;a.fillStyle="rgba("+u+","+h+","+f+",0.9)",a.fillRect(0,0,l+e.length*o.letterSpacing+2*o.padding,c),a.fillStyle=o.color.getStyle(),a.renderText(e,o.padding,1.4*r,o.letterSpacing);var v=new THREE.Texture(i);v.needsUpdate=!0;var p=new THREE.SpriteMaterial({map:v,useScreenCoordinates:!1,alignment:0});p.needsUpdate=!0;var m=new THREE.Sprite(p),E=o.size*d/c;return m.scale.set(E,E*(c/d),1),m}},CMAP.classes.Animation=function(e){var t,r,o=!1,i=[],n=function(e,t,r){var o=t-e;return e+o*r},a=function(e,t,r){e instanceof THREE.Vector3&&e.copy(CMAP.tools.lerp3(r.from,r.to,t)),e instanceof THREE.Material&&("opacity"===r.type&&(e.transparent=!0,e.opacity=n(r.from,r.to,t)),"color"===r.type&&(e.color=r.from.lerp(r.to,t))),e instanceof THREE.Mesh&&e.scale.copy(CMAP.tools.lerp3(r.from,r.to,t)),r.tick instanceof Function&&r.tick(e,t,r,n)},s=function(e,t){if(e instanceof THREE.Vector3)return e.clone();if(e instanceof THREE.Material){if("opacity"===t.type)return e.opacity;if("color"===t.type)return e.color.clone()}return e instanceof THREE.Mesh?e.scale.clone():void 0},l=function(){o&&e.render.remove(t);for(var n=0;n<i.length;n++){var s=i[n],l=!1;s.start||(s.start=+Date.now()),r&&(s.start+=+Date.now()-r);var c=+Date.now()-s.start,d=c/s.duration;d>1&&(d=1,l=!0),a(s.property,d,s),l&&i.splice(n,1)}r&&(r=void 0),i.length>0&&e.render.remove(t)}.bind(this),c=function(){r=+Date.now()};this.add=function(e,t){var r=t.from||s(e,t);i.push({from:r,to:t.to,duration:t.duration||1e3,ease:"easeInOutCubic",property:e,type:t.type,tick:t.tick})},this.start=function(){o=!1,t=e.render.add(l,c)},this.stop=function(){o=!0,e.render.remove(t)}},CMAP.classes.Compass=function(e){var t,r=this;this.getDirection=function(){var t=e.camera.quaternion,r=new THREE.Vector3(1,0,0).applyQuaternion(t),o=Math.atan2(r.z,r.x);return o+=Math.PI/2,o*=180/Math.PI,o=o>0?o:o+360,o=Math.floor(o%360)},this.updateElement=function(e){t=window.setInterval(function(){var t=r.getDirection();e.style.webkitTransform="rotate("+t+"deg)",e.style.mozTransform="rotate("+t+"deg)",e.style.transform="rotate("+t+"deg)"},250)},this.destroy=function(){window.clearInterval(t)}},CMAP.classes.renderManager=function(){var e,t=[],r=!1,o=new THREE.Clock;this.add=function(e,r){var o=CMAP.tools.UID();return t.push({task:e,pause:r,id:CMAP.tools.UID()}),o},this.remove=function(e){for(var r=0;r<t.length;r++)t[r].id===e&&t.splice(r,1)},this.clear=function(){t=[],o.stop()};var i=function(){if(r)return r=!1,!1;e=window.requestAnimationFrame(i);for(var n=o.getDelta(),a=0;a<t.length;a++)t[a].task(n)};this.start=function(){r=!1,e&&window.cancelAnimationFrame(e),i()},this.stop=function(o){r=!0,window.cancelAnimationFrame(e);for(var i=0;i<t.length;i++)t[i].pause&&t[i].pause();o&&this.clear()}},CMAP.tools.createThree=function(e,t){var r=e.offsetWidth,o=e.offsetHeight;1024>r&&(r=1024),t&&(o=t),this.renderer=new THREE.WebGLRenderer({antialias:!0,devicePixelRatio:1}),this.renderer.setClearColor(16777215,1),this.renderer.setSize(r,o),this.group=new THREE.Object3D,this.camera=new CMAP.classes.GeoCamera(60,r/o,1,5e3,this.group),this.camera.position.z=1500,this.scene=new THREE.Scene,this.scene.fog=new THREE.FogExp2(11184810,75e-5),this.scene.add(this.group),this.group.rotateX(Math.PI/2),this.group.rotateZ(-Math.PI/2),this.group.updateMatrixWorld();var i=new THREE.HemisphereLight(16777215,16777215,1);this.scene.add(i),e.appendChild(this.renderer.domElement)},Math.easeInOutQuad=function(e,t,r,o){return e/=o/2,1>e?r/2*e*e+t:(e--,-r/2*(e*(e-2)-1)+t)},Math.easeInOutCubic=function(e,t,r,o){return e/=o/2,1>e?r/2*e*e*e+t:(e-=2,r/2*(e*e*e+2)+t)},CMAP.tools.lerp3=function(e,t,r){return new THREE.Vector3(Math.easeInOutCubic(r,e.x,t.x-e.x,1),Math.easeInOutCubic(r,e.y,t.y-e.y,1),Math.easeInOutCubic(r,e.z,t.z-e.z,1))},CMAP.tools.mergeMaps=function(e,t){for(var r=0;r<t.length;r++)e=e.concat(t[r])},CMAP.tools.parseHeight=function(e){return-e},CMAP.tools.UID=function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?r:7&r|8).toString(16)});return t},CMAP.tools.actionExtend=function(e,t){var r=e;for(var o in t)r[o]?r[o]instanceof Function?r[o]=[r[o],t[o]]:r[o].push(t[o]):r[o]=t[o];return r},CMAP.tools.destroyGroup=function(e,t){if(!e.children)return!1;for(var r=0;r<e.children.length;r++){var o=e.children[r];if(t.remove(o),e.remove(o),o.geometry&&(o.geometry.dispose(),o.geometry=void 0),o.material){if(o.material.materials)for(r=0;r<o.material.materials.length;r++)o.material.materials[r].dispose();else o.material.dispose();o.material=void 0}o.texture&&(o.texture.dispose(),o.texture=void 0),o.dispose&&o.dispose(),o=void 0}},CMAP.tools.VideoTexture=function(e,t,r,o,i,n,a,s,l,c){THREE.Texture.call(this,t,r,o,i,n,a,s,l,c),this.generateMipmaps=!1;var d=this,u=function(){t.readyState===t.HAVE_ENOUGH_DATA&&(d.needsUpdate=!0)};e.render.add(u)},CMAP.tools.VideoTexture.prototype=Object.create(THREE.Texture.prototype),CMAP.FXlib=CMAP.FXlib||{},CMAP.FXlib.copyShader=function(){if(!this.composer)return console.warn("composer not found"),!1;var e=new THREE.ShaderPass(THREE.CopyShader);e.renderToScreen=!0,this.composer.addPass(e)},CMAP.FXlib=CMAP.FXlib||{},CMAP.FXlib.FXAA=function(e,t,r,o){return this.composer&&"hq"===o.quality?(this.effectFXAA=new THREE.ShaderPass(THREE.FXAAShader),void this.composer.addPass(this.effectFXAA)):!1},CMAP.FXlib=CMAP.FXlib||{},CMAP.FXlib.tiltShift=function(e,t,r,o){if(!this.composer)return console.warn("composer not found"),!1;var i;this.setBlur=function(e,t,r,n){if(r=r||1,n){var a=new CMAP.classes.Animation(o),s=n===!0?1e3:n,l=function(e,t,r,o){var i=o(r.from[0],r.to[0],t),n=o(r.from[1],r.to[1],t),a=o(r.from[2],r.to[2],t);e.setBlur(i,n,a)};a.add(this,{from:i,to:[e,t,r],duration:s,tick:l}),a.start()}else this.hblur.uniforms.h.value=e/window.innerWidth,this.vblur.uniforms.v.value=e/window.innerHeight,this.hblur.uniforms.r.value=t,this.vblur.uniforms.r.value=t,this.hblur.uniforms.spread.value=r,this.vblur.uniforms.spread.value=r,i=[e,t,r]},this.hblur=new THREE.ShaderPass(THREE.HorizontalTiltShiftShader),this.vblur=new THREE.ShaderPass(THREE.VerticalTiltShiftShader),this.setBlur(20,.55,1.65),this.composer.addPass(this.hblur),this.composer.addPass(this.vblur)},CMAP.build.pointGrid=function(e){var t,r,o=this.options.pointSize||5,i=this.z||0,n=window.devicePixelRatio||1,a=new THREE.Object3D,s=[];for(r=0;r<this.options.colors.length;r++){var l=[],c=new THREE.Color(this.options.colors[r]),d=document.createElement("canvas"),u=d.getContext("2d");u.canvas.width=10,u.canvas.height=10,u.fillStyle=c.getStyle(),u.beginPath(),u.arc(5,5,5,0,2*Math.PI),u.fill();var h=new THREE.Texture(d);h.needsUpdate=!0;var f=new THREE.PointCloudMaterial({size:o/n,vertexColors:!1,map:h,transparent:!0});s.push({vertices:l,material:f})}for(r=0;r<this.data.length;r++){var v=parseInt(this.data[r].type),p=e.projection.translate3D(this.data[r].lon,this.data[r].lat);s[v].vertices.push(new THREE.Vector3(p.x,p.y,this.z))}for(r=0;r<s.length;r++){var m=new THREE.Geometry;m.vertices=s[r].vertices,t=new THREE.PointCloud(m,s[r].material),m.verticesNeedUpdate=!0,t.geometry.dirtyVertices=!0,a.add(t),s[r].system=t}e.group.add(a);var E;return{highlight:function(){E&&E.stop();var t=a.position.clone(),r=t.clone();r.z=CMAP.tools.parseHeight(-50);var o=new CMAP.classes.Animation(e);o.add(a.position,{from:t,to:r,duration:1e3}),o.start(),E=o},resetHighlight:function(){E&&E.stop();var t=a.position.clone(),r=t.clone();r.z=CMAP.tools.parseHeight(i);var o=new CMAP.classes.Animation(e);o.add(a.position,{from:t,to:r,duration:1e3}),o.start(),E=o}}},CMAP.build.tubes3DVideo=function(e){var t=this.options,r=this.data,o=this.boundingbox;t.width=t.width||1.5,t.radiusSegments=t.radiusSegments||3,t.offsetX=t.offsetX||0,t.offsetY=t.offsetY||0,t.speed=t.speed||1;for(var i=function(e){e.computeBoundingBox();var r=e.boundingBox.max,i=e.boundingBox.min;i=new THREE.Vector3(o.box3D.min.x+t.offsetY,o.box3D.min.y+t.offsetX,i.z),r=new THREE.Vector3(o.box3D.max.x+t.offsetY,o.box3D.max.y+t.offsetX,r.z);var n=new THREE.Vector2(0-i.x,0-i.y),a=new THREE.Vector2(r.x-i.x,r.y-i.y);e.faceVertexUvs[0]=[];var s=e.faces;for(c=0;c<e.faces.length;c++){var l=e.vertices[s[c].a],d=e.vertices[s[c].b],u=e.vertices[s[c].c];e.faceVertexUvs[0].push([new THREE.Vector2((l.x+n.x)/a.x,(l.y+n.y)/a.y),new THREE.Vector2((d.x+n.x)/a.x,(d.y+n.y)/a.y),new THREE.Vector2((u.x+n.x)/a.x,(u.y+n.y)/a.y)])}e.uvsNeedUpdate=!0},n=new THREE.Geometry,a=function(){var r=t.video,o=new CMAP.tools.VideoTexture(e,r);o.minFilter=THREE.LinearFilter,o.magFilter=THREE.LinearFilter,o.format=THREE.RGBFormat,o.generateMipmaps=!1,i(n);var a=new THREE.BufferGeometry;a.fromGeometry(n),n.dispose();var s=new THREE.MeshLambertMaterial({color:16777215,map:o,shininess:10}),l=new THREE.Mesh(a,s);if(t.debug){var c=new THREE.PlaneGeometry(1500,1500),d=s.clone();d.side=THREE.BackSide,i(c);var u=new THREE.Mesh(c,d);e.group.add(u)}e.group.add(l),r.playbackRate=t.speed}.bind(this),s=function(e){var r=new THREE.SplineCurve3(e),o=e.length<50?e.length:50,i=new THREE.TubeGeometry(r,o,t.width,t.radiusSegments,!1);n.merge(i),i.dispose(),r=void 0},l=function(){var e=this.start,t=e+10,o=r.length-1;t=t>o?o:t;for(var i=e;t>i;i++)s(r[i]);t>=r.length-1&&a()},c=0;c<r.length;c+=10){var d=l.bind({start:c});window.setTimeout(d)}},CMAP.build.tubesColor=function(e){var t,r=this.options,o=this.data,i=this.z;r.color=r.color||new THREE.Color("#FFFFFF"),r.width=r.width||1.5,r.maxSegments=r.maxSegments||50,r.radiusSegments=r.radiusSegments||3,r.quality=r.quality||1,r.opacity=r.opacity||1;for(var n=new THREE.Geometry,a=function(){var o={};o.color=r.color,r.opacity<1&&(o.opacity=r.opacity,o.transparent=!0);var a=new THREE.BufferGeometry;a.fromGeometry(n),n.dispose();var s=new THREE.MeshLambertMaterial(o);t=new THREE.Mesh(a,s),t.position.z=CMAP.tools.parseHeight(i),e.group.add(t)}.bind(this),s=function(e){var t=new THREE.SplineCurve3(e),o=e.length<r.maxSegments?e.length:r.maxSegments;o=Math.ceil(r.quality*o);var i=new THREE.TubeGeometry(t,o,r.width,r.radiusSegments,!1);n.merge(i),i.dispose(),t=null},l=function(){var e=this.start,t=e+10,r=o.length-1;t=t>r?r:t,1===o.length&&(t=1);for(var i=e;t>i;i++)s(o[i]);t>=o.length-1&&a()},c=0;c<o.length;c+=10){var d=l.bind({start:c});window.setTimeout(d)}var u;return{highlight:function(){u&&u.stop();var o=t.position.clone(),i=o.clone();i.z=CMAP.tools.parseHeight(50);var n=new CMAP.classes.Animation(e);n.add(t.position,{from:o,to:i,duration:1e3}),n.add(t.material,{from:t.material.opacity,to:1,type:"opacity"}),r.hover&&n.add(t.material,{from:r.color.clone(),to:r.hover.clone(),type:"color"}),n.start(),u=n},lowlight:function(){u&&u.stop();var o=t.position.clone(),n=o.clone();n.z=CMAP.tools.parseHeight(i);var a=new CMAP.classes.Animation(e);a.add(t.position,{from:o,to:n,duration:1e3}),r.hover&&a.add(t.material,{from:t.material.color.clone(),to:r.color.clone(),type:"color"}),a.add(t.material,{from:t.material.opacity,to:.2,type:"opacity"}),a.start(),u=a},resetHighlight:function(){u&&u.stop();var o=t.position.clone(),n=o.clone();n.z=CMAP.tools.parseHeight(i);var a=new CMAP.classes.Animation(e);a.add(t.position,{from:o,to:n,duration:1e3}),a.add(t.material,{from:t.material.opacity,to:r.opacity,type:"opacity"}),r.hover&&a.add(t.material,{from:t.material.color.clone(),to:r.color.clone(),type:"color"}),a.start(),u=a}}},CMAP.build.highlights=function(e){var t=this.z,r=new THREE.Object3D;e.group.add(r);for(var o=[],i=0;i<this.data.length;i++){var n;if(this.options.mesh)n=this.options.mesh.clone();else{var a=new CMAP.classes.Label3D;a.background().text(this.data[i].properties.label),n=a.create(),n.position.copy(this.data[i]),n.position.z=t;var s=n.position.clone();s.z+=5;var l=s.clone();l.z=0,this.data[i].properties.offset&&(s.z-=this.data[i].properties.offset,n.position.z-=this.data[i].properties.offset);var c=new THREE.MeshLambertMaterial({color:2832193}),d=new THREE.SplineCurve3([s,l]),u=new THREE.TubeGeometry(d,2,.75,8,!1),h=new THREE.Mesh(u,c),f=new THREE.SphereGeometry(2.5,8,6,Math.PI,Math.PI),v=new THREE.MeshBasicMaterial({color:3355443}),p=new THREE.Mesh(f,v);p.material.side=THREE.DoubleSide,p.position.copy(l),r.add(h),r.add(n),r.add(p),o.push({id:CMAP.tools.UID(),label:this.data[i].properties.label,mesh:n,line:h,base:p,pos:n.position.clone(),highlight:this.data[i].properties.highlight,geo:e.projection.reverse(n.position)})}var m=this.options.click.bind(this.data[i]);e.mouse.addSpot(n,m)}var E;return{highlight:function(){E&&E.stop();var t=r.position.clone(),o=t.clone();o.z=CMAP.tools.parseHeight(50);var i=new CMAP.classes.Animation(e);i.add(r.position,{from:t,to:o,duration:1e3}),i.start(),E=i},resetHighlight:function(){E&&E.stop();var t=r.position.clone(),o=t.clone();o.z=CMAP.tools.parseHeight(0);var i=new CMAP.classes.Animation(e);i.add(r.position,{from:t,to:o,duration:1e3}),i.start(),E=i},getPoints:function(){return o},fadeOut:function(){for(var t=0;t<o.length;t++){var r=o[t],i=new CMAP.classes.Animation(e);i.add(r.mesh.material,{from:void 0,to:0,type:"opacity",duration:500}),i.add(r.line.material,{from:void 0,to:0,type:"opacity",duration:500}),i.start()}},fadeIn:function(){for(var t=0;t<o.length;t++){var r=o[t];r.mesh.material.opacity=0,r.mesh.material.transparent=!0;var i=new CMAP.classes.Animation(e);i.add(r.mesh.material,{from:void 0,to:1,type:"opacity",duration:500}),i.add(r.line.material,{from:void 0,to:1,type:"opacity",duration:500}),i.start()}},highlightPoint:function(t){for(var r=0;r<o.length;r++){var i=o[r];i.mesh.material.opacity=0,i.mesh.material.transparent=!0;var n=new CMAP.classes.Animation(e),a=1;i.id&&i.id===t&&(a=2),n.add(i.base,{from:void 0,to:new THREE.Vector3(a,a,a),duration:500}),n.start()}}}},CMAP.build.tracers=function(e){var t=this.z,r=this.options.amount||50,o=this.options.speed||.001,i=this.options.pointSize||10,n=this.options.points||50,a=.005;i/=window.devicePixelRatio||1;var s=[],l=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.5}),c=new THREE.SphereGeometry(2),d=new THREE.Mesh(c,l),u=document.createElement("canvas"),h=u.getContext("2d");h.canvas.width=10,h.canvas.height=10,h.fillStyle=this.options.hover.getStyle(),h.beginPath(),h.arc(5,5,5,0,2*Math.PI),h.fill();var f=new THREE.Texture(u);f.needsUpdate=!0;var v=new THREE.Geometry,p=new THREE.PointCloudMaterial({size:i,vertexColors:!1,map:f,transparent:!0}),m=new THREE.PointCloud(v,p);e.group.add(m);for(var E=0;r>E;E++){var g=Math.floor(Math.random()*this.data.length)+1,y=new THREE.SplineCurve3(this.data[g]);if(y.points.length>1){for(var x=0;n>x;x++)v.vertices.push(new THREE.Vector3),v.colors.push(this.options.color);var w=d.clone();s.push({path:y,i:E*n,current:Math.random(),head:w})}}var T=function(){for(var e=0;e<s.length;e++){var t=s[e];t.rev?t.current-=o:t.current+=o,t.current>=1?(t.current=1,t.rev=!0):t.current<=0&&(t.current=0,t.rev=!1);var r=t.rev?t.current:t.current+n*a;r>1&&(r=1),0>r&&(r=0);var i=t.path.getPointAt(r);t.head.position.copy(i);for(var l=t.i;l<t.i+n;l++){var c=l-t.i,d=t.current+c*a;d>1&&(d=1),0>d&&(d=0);var u=t.path.getPointAt(d);m.geometry.vertices[l].copy(u)}}v.verticesNeedUpdate=!0,v.dirtyVertices=!0};e.render.add(T);var M;return{highlight:function(){M&&M.stop();var t=m.position.clone(),r=t.clone();r.z=CMAP.tools.parseHeight(50);var o=new CMAP.classes.Animation(e);o.add(m.position,{from:t,to:r,duration:1e3}),o.start(),M=o},resetHighlight:function(){M&&M.stop();var r=m.position.clone(),o=r.clone();o.z=CMAP.tools.parseHeight(t);var i=new CMAP.classes.Animation(e);i.add(m.position,{from:r,to:o,duration:1e3}),i.start(),M=i}}},CMAP.build.satellite=function(e){var t=this.options,r=this.data,o=this.boundingbox;t.offsetX=t.offsetX||2,t.offsetY=t.offsetY||0;var i=o.box3D.max.x-o.box3D.min.x,n=o.box3D.min.y-o.box3D.max.y,a=i/2-o.box3D.max.x,s=n/2-o.box3D.min.y,l=new THREE.PlaneBufferGeometry(i,n);r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,r.format=THREE.RGBFormat,r.generateMipmaps=!1;var c=new THREE.MeshBasicMaterial({map:r});c.side=THREE.BackSide;var d=new THREE.Mesh(l,c);d.position.x=-a,d.position.y=-s,d.position.z=CMAP.tools.parseHeight(-this.z),e.group.add(d)},function(){function e(t,r,o){function i(e){var i=t(e),n=o>i,a=d3.extent(t.range()),s=a[0],l=a[1],c=n?o-s:l-o;
return 0==c&&(c=l-s),(n?-1:1)*c*(r+1)/(r+c/Math.abs(i-o))+o}return i.distortion=function(e){return arguments.length?(r=+e,i):r},i.focus=function(e){return arguments.length?(o=+e,i):o},i.copy=function(){return e(t.copy(),r,o)},i.nice=t.nice,i.ticks=t.ticks,i.tickFormat=t.tickFormat,d3.rebind(i,t,"domain","range")}d3.fisheye={scale:function(t){return e(t(),3,0)},circular:function(){function e(e){var t=e.x-a[0],n=e.y-a[1],s=Math.sqrt(t*t+n*n);if(!s||s>=i)return{x:e.x,y:e.y,z:1};var l=r*(1-Math.exp(-s*o))/s*.75+.25;return{x:a[0]+t*l,y:a[1]+n*l,z:Math.min(l,10)}}function t(){return r=Math.exp(n),r=r/(r-1)*i,o=n/i,e}var r,o,i=200,n=2,a=[0,0];return e.radius=function(e){return arguments.length?(i=+e,t()):i},e.distortion=function(e){return arguments.length?(n=+e,t()):n},e.focus=function(t){return arguments.length?(a=t,e):a},t()}}}();